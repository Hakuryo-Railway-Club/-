<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>運転ゲーム（速度表示付き）</title>

<style>
  body {
    margin: 0;
    background: black;
    color: white;
    font-family: sans-serif;
    overflow: hidden;
  }

  /* 速度計 */
  #speedBox {
    position: fixed;
    right: 20px;
    bottom: 20px;
    background: rgba(0,0,0,0.7);
    padding: 20px;
    border: 2px solid white;
    text-align: center;
    width: 180px;
  }

  #speed {
    font-size: 48px;
    font-weight: bold;
  }

  #unit {
    font-size: 20px;
  }

  #notch {
    margin-top: 10px;
    font-size: 24px;
  }

  #help {
    position: fixed;
    left: 10px;
    bottom: 10px;
    font-size: 16px;
    opacity: 0.8;
  }
</style>
</head>
<body>

<div id="speedBox">
  <div id="speed">0.00</div>
  <div id="unit">km/h</div>
  <div id="notch">N</div>
</div>

<div id="help">
  ↑ 力行　↓ 制動
</div>

<script>
/* =====================
   状態変数
===================== */
let mode = "N"; // "P", "N", "B"
let P = 0;      // 1～5
let B = 0;      // 1～8
let k = 0;      // 速度 km/h

// 加速用
let A = 0;
let C = 0; // 秒

const DT = 1 / 120;

/* =====================
   ノッチ操作
===================== */
document.addEventListener("keydown", e => {
  if (e.key === "ArrowUp") notchUp();
  if (e.key === "ArrowDown") notchDown();
});

function notchUp() {
  if (mode === "P") {
    if (P < 5) P++;
  } else if (mode === "N") {
    mode = "P";
    P = 1;
    resetAccel();
  } else if (mode === "B") {
    if (B > 1) {
      B--;
    } else {
      mode = "N";
      B = 0;
    }
  }
}

function notchDown() {
  if (mode === "P") {
    if (P > 1) {
      P--;
    } else {
      mode = "N";
      P = 0;
    }
    resetAccel();
  } else if (mode === "N") {
    mode = "B";
    B = 1;
  } else if (mode === "B") {
    if (B < 8) B++;
  }
}

/* =====================
   加速初期化
===================== */
function resetAccel() {
  if (mode !== "P") return;

  const vmax = 30 * P;
  A = 120 - ((vmax * vmax - k * k) / vmax) * 120;
  if (A < 0) A = 0;
  C = 0;
}

/* =====================
   メイン更新
===================== */
function update() {
  if (mode === "P") {
    powerUpdate();
  } else if (mode === "N") {
    if (k > 0) k -= 0.01;
  } else if (mode === "B") {
    if (k > 0) k -= 0.01 * B;
  }

  if (k < 0) k = 0;

  drawUI();
  requestAnimationFrame(update);
}

function powerUpdate() {
  const vmax = 30 * P;

  if (k > vmax) {
    k -= 0.01;
    if (k < vmax) k = vmax;
    return;
  }

  if (k < vmax) {
    C += DT;
    let D = A + C;
    if (D > 120) D = 120;

    const t = ((120 - D) / 120) * vmax;
    k = Math.sqrt(vmax * vmax - t * t);
  }
}

/* =====================
   UI表示
===================== */
function drawUI() {
  document.getElementById("speed").textContent = k.toFixed(2);

  let notchText = "N";
  if (mode === "P") notchText = "P" + P;
  if (mode === "B") notchText = "B" + B;

  document.getElementById("notch").textContent = notchText;
}

/* =====================
   起動
===================== */
update();
</script>

</body>
</html>
